# Azure DevOps Task: TerraformTask@5
#
# Purpose:
# This template is designed to execute Terraform commands in an Azure DevOps pipeline. It supports a variety of commands,
# including `init`, `plan`, `apply`, `destroy`, and custom commands, with specific configurations for Azure backend and provider settings.
#
# Features:
# - Supports Azure as the cloud provider.
# - Provides conditional parameter validation and command-specific parameter handling.
# - Includes comprehensive backend configuration for Azure.
# - Implements fail-fast error handling for robust pipeline execution.
#
# Parameters:
# - `Command` (string, required): Specifies the Terraform command to execute. Supported values:
#   - `init`, `validate`, `show`, `plan`, `apply`, `output`, `destroy`, `custom`.
# - `WorkingDirectory` (string, optional): Specifies the working directory for Terraform files. Default: `$(Pipeline.Workspace)`.
# - `CommandOptions` (string, optional): Additional arguments for the Terraform command. Default: `''`.
# - `CustomCommand` (string, optional): Custom Terraform command to execute when `Command` is set to `custom`. Default: `''`.
# - `OutputTo` (string, optional): Specifies the output destination for `show` or `output` commands. Default: `console`. Supported values:
#   - `console`, `file`.
# - `OutputFileName` (string, optional): Specifies the output file name when `OutputTo` is set to `file`. Default: `''`.
# - `OutputFormat` (string, optional): Specifies the output format for the `show` command. Default: `default`. Supported values:
#   - `default`, `json`.
# - `BackendAzureServiceConnection` (string, optional): Azure service connection for backend state storage. Default: `''`.
# - `BackendAzureResourceGroupName` (string, optional): Azure resource group name for backend state storage. Default: `''`.
# - `BackendAzureStorageAccountName` (string, optional): Azure storage account name for backend state storage. Default: `''`.
# - `BackendAzureContainerName` (string, optional): Azure storage container name for backend state storage. Default: `''`.
# - `BackendAzureBlobName` (string, optional): Azure storage blob name for backend state storage. Default: `''`.
# - `DisableBackend` (boolean, optional): Disables backend configuration during the `init` command. Default: `false`.
# - `EnvironmentAzureServiceConnection` (string, optional): Azure service connection for provider configuration. Default: `''`.
#
# Usage Examples:
# - Initialize Terraform:
#   ```yaml
#   - template: tasks/terraform.yml
#     parameters:
#       Command: 'init'
#       BackendAzureServiceConnection: 'my-azure-connection'
#   ```
# - Plan Terraform changes:
#   ```yaml
#   - template: tasks/terraform.yml
#     parameters:
#       Command: 'plan'
#       CommandOptions: '-out=tfplan'
#   ```
# - Apply Terraform changes:
#   ```yaml
#   - template: tasks/terraform.yml
#     parameters:
#       Command: 'apply'
#       CommandOptions: 'tfplan'
#   ```
#
# Notes:
# - This template is tailored for Azure and does not support other cloud providers.
# - Certain Azure-specific parameters are excluded for simplicity.
# - The `DisableBackend` parameter allows backend configuration to be skipped during the `init` command.

parameters:
  - name: Command
    type: string
    displayName: 'Terraform command (init, plan, apply, etc.)'
    values:
      - init
      - validate
      - show
      - plan
      - apply
      - output
      - destroy
      - custom

  - name: WorkingDirectory
    type: string
    displayName: 'Directory containing Terraform configuration files'
    default: '$(Pipeline.Workspace)'

  - name: CommandOptions
    type: string
    displayName: 'Extra arguments for the Terraform command'
    default: ''

  - name: CustomCommand
    type: string
    displayName: 'Custom Terraform CLI command (when Command is custom)'
    default: ''

  # Output Configuration (for show/output commands)
  - name: OutputTo
    type: string
    displayName: 'Where to send output for show/output commands'
    default: 'console'
    values:
      - console
      - file

  - name: OutputFileName
    type: string
    displayName: 'File name for output (when OutputTo is file)'
    default: ''

  - name: OutputFormat
    type: string
    displayName: 'Format for show command output'
    default: 'default'
    values:
      - default
      - json

  # Azure Backend Configuration (for init command)
  - name: BackendAzureServiceConnection
    type: string
    displayName: 'Azure service connection for backend state storage'
    default: ''

  - name: BackendAzureResourceGroupName
    type: string
    default: ''
    displayName: 'Azure resource group for backend state storage'

  - name: BackendAzureStorageAccountName
    type: string
    default: ''
    displayName: 'Azure storage account for backend state storage'

  - name: BackendAzureContainerName
    type: string
    default: ''
    displayName: 'Azure storage container for backend state storage'

  - name: BackendAzureBlobName
    type: string
    default: ''
    displayName: 'Azure blob name (key) for backend state storage'

  - name: DisableBackend
    type: boolean
    displayName: 'Skip backend configuration during init'
    default: false

  # Azure Provider Environment Configuration (for plan/apply/destroy commands)
  - name: EnvironmentAzureServiceConnection
    type: string
    displayName: 'Azure service connection for provider authentication'
    default: ''

steps:
  - ${{ if and(eq(parameters.Command, 'init'), eq(parameters.DisableBackend, true)) }}:
      - script: 'terraform init -backend=false'
        displayName: 'Terraform ${{ parameters.Command }}'
        name: TerraformTask_init
        workingDirectory: ${{ parameters.WorkingDirectory }}

  - ${{ else }}:
      - task: TerraformTask@5
        displayName: 'Terraform ${{ parameters.Command }}'
        name: TerraformTask_${{ parameters.Command }}
        inputs:
          # Core Configuration
          provider: 'azurerm'
          command: '${{ parameters.Command }}'
          ${{ if ne(parameters.WorkingDirectory, '') }}:
            workingDirectory: '${{ parameters.WorkingDirectory }}'

          # Command Options
          ${{ if ne(parameters.CommandOptions, '') }}:
            commandOptions: '${{ parameters.CommandOptions }}'

          ${{ if and(eq(parameters.Command, 'custom'), ne(parameters.CustomCommand, '')) }}:
            customCommand: '${{ parameters.CustomCommand }}'

          # Output Configuration (show/output commands)
          ${{ if and(or(eq(parameters.Command, 'show'), eq(parameters.Command, 'output')), ne(parameters.OutputTo, 'console')) }}:
            outputTo: '${{ parameters.OutputTo }}'

          ${{ if and(eq(parameters.OutputTo, 'file'), ne(parameters.OutputFileName, '')) }}:
            fileName: '${{ parameters.OutputFileName }}'

          ${{ if and(eq(parameters.Command, 'show'), ne(parameters.OutputFormat, 'default')) }}:
            outputFormat: '${{ parameters.OutputFormat }}'

          # Azure Backend Configuration (init command)
          ${{ if eq(parameters.Command, 'init') }}:
            ${{ if ne(parameters.BackendAzureServiceConnection, '') }}:
              backendServiceArm: '${{ parameters.BackendAzureServiceConnection }}'

            ${{ if ne(parameters.BackendAzureResourceGroupName, '') }}:
              backendAzureRmResourceGroupName: '${{ parameters.BackendAzureResourceGroupName }}'

            ${{ if ne(parameters.BackendAzureStorageAccountName, '') }}:
              backendAzureRmStorageAccountName: '${{ parameters.BackendAzureStorageAccountName }}'

            ${{ if ne(parameters.BackendAzureContainerName, '') }}:
              backendAzureRmContainerName: '${{ parameters.BackendAzureContainerName }}'

            ${{ if ne(parameters.BackendAzureBlobName, '') }}:
              backendAzureRmKey: '${{ parameters.BackendAzureBlobName }}'

          # Azure Provider Configuration (plan/apply/destroy commands)
          ${{ if or(eq(parameters.Command, 'plan'), eq(parameters.Command, 'apply'), eq(parameters.Command, 'destroy')) }}:
            ${{ if ne(parameters.EnvironmentAzureServiceConnection, '') }}:
              environmentServiceNameAzureRM: '${{ parameters.EnvironmentAzureServiceConnection }}'
