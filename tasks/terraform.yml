# Azure DevOps Task: TerraformTask@5
#
# Purpose:
#   Executes Terraform commands in an Azure DevOps pipeline, supporting Azure as the backend and provider.
#   Handles commands such as `init`, `plan`, `apply`, `destroy`, and custom commands, with flexible backend and provider configuration.
#
# Parameters:
#   - TaskEnvironmentVariables (object, optional): Environment variables to be passed to the task.
#   - TaskNameUniqueSlug (string, optional): Unique string to add to the task name to make it unique if the same command is repeated.
#   - WorkingDirectory (string, optional): Directory containing Terraform configuration files. Default: $(Pipeline.Workspace)
#   - Condition (string, optional): Evaluate this condition expression to determine whether to run this task. Default: succeeded()
#   - RetryCountOnTaskFailure (number, optional): Number of times to retry the task on failure. Default: 3
#   - Command (string, required): The Terraform command to execute. Supported: init, validate, show, plan, apply, output, destroy, custom.
#   - CommandOptions (string, optional): Extra arguments for the Terraform command. Default: ''
#   - CustomCommand (string, optional): Custom Terraform CLI command (when Command is custom). Default: ''
#   - OutputTo (string, optional): Where to send output for show/output commands. Values: console, file. Default: console
#   - OutputFileName (string, optional): File name for output (when OutputTo is file). Default: ''
#   - OutputFormat (string, optional): Format for show command output. Values: default, json. Default: default
#   - BackendAzureServiceConnection (string, optional): Azure service connection for backend state storage. Default: ''
#   - BackendAzureResourceGroupName (string, optional): Azure resource group for backend state storage. Default: ''
#   - BackendAzureStorageAccountName (string, optional): Azure storage account for backend state storage. Default: ''
#   - BackendAzureContainerName (string, optional): Azure storage container for backend state storage. Default: ''
#   - BackendAzureBlobName (string, optional): Azure blob name (key) for backend state storage. Default: ''
#   - DisableBackend (boolean, optional): Skip backend configuration during init. Default: false
#   - UseLocalBackend (boolean, optional): Only init for using the local backend. Default: false
#   - EnvironmentAzureServiceConnection (string, optional): Azure service connection for provider authentication. Default: ''
#
# Example Usage:
#   - template: tasks/terraform.yml
#     parameters:
#       Command: 'init'
#       BackendAzureServiceConnection: 'my-azure-connection'
#
#   - template: tasks/terraform.yml
#     parameters:
#       Command: 'plan'
#       CommandOptions: '-out=tfplan'
#
#   - template: tasks/terraform.yml
#     parameters:
#       Command: 'apply'
#       CommandOptions: 'tfplan'
#
#   - template: tasks/terraform.yml
#     parameters:
#       Command: 'output'
#       OutputTo: 'file'
#
# Notes:
#   - This template is designed for Azure and does not support other cloud providers.
#   - Uses the TerraformTask@5 task from Microsoft DevLabs.
#   - The DisableBackend parameter allows backend configuration to be skipped during init.
#   - This TerraformTask is from this [extension](https://marketplace.visualstudio.com/items?itemName=ms-devlabs.custom-terraform-tasks)

parameters:
  # Standard Azure DevOps Task Parameters
  - name: TaskEnvironmentVariables
    type: object
    displayName: 'Key/value pairs of environment variables to be passed to the task'
    default: { }

  - name: TaskNameUniqueSlug
    type: string
    displayName: 'Unique string to add to the task name to make it unique if the same command is repeated'
    default: ''

  - name: Condition
    type: string
    displayName: 'Evaluate this condition expression to determine whether to run this task'
    default: succeeded()

  - name: WorkingDirectory
    type: string
    displayName: 'Directory containing Terraform configuration files'
    default: '$(Pipeline.Workspace)'

  - name: RetryCountOnTaskFailure
    type: number
    displayName: 'Number of times to retry the task on failure'
    default: 3

  # Specific TerraformCLI Task Parameters

  - name: Command
    type: string
    displayName: 'Terraform command (init, plan, apply, etc.)'
    values:
      - init
      - validate
      - show
      - plan
      - apply
      - output
      - destroy
      - custom

  - name: CommandOptions
    type: string
    displayName: 'Extra arguments for the Terraform command'
    default: ''

  - name: CustomCommand
    type: string
    displayName: 'Custom Terraform CLI command (when Command is custom)'
    default: ''

  # Output Configuration (for show/output commands)
  - name: OutputTo
    type: string
    displayName: 'Where to send output for show/output commands'
    default: 'console'
    values:
      - console
      - file

  - name: OutputFileName
    type: string
    displayName: 'File name for output (when OutputTo is file)'
    default: ''

  - name: OutputFormat
    type: string
    displayName: 'Format for show command output'
    default: 'default'
    values:
      - default
      - json

  # Azure Backend Configuration (for init command)
  - name: BackendAzureServiceConnection
    type: string
    displayName: 'Azure service connection for backend state storage'
    default: ''

  - name: BackendAzureResourceGroupName
    type: string
    default: ''
    displayName: 'Azure resource group for backend state storage'

  - name: BackendAzureStorageAccountName
    type: string
    default: ''
    displayName: 'Azure storage account for backend state storage'

  - name: BackendAzureContainerName
    type: string
    default: ''
    displayName: 'Azure storage container for backend state storage'

  - name: BackendAzureBlobName
    type: string
    default: ''
    displayName: 'Azure blob name (key) for backend state storage'

  - name: DisableBackend
    type: boolean
    displayName: 'Skip backend configuration during init'
    default: false

  - name: UseLocalBackend
    type: boolean
    displayName: 'Only init for using the local backend'
    default: false

  # Azure Provider Environment Configuration (for plan/apply/destroy commands)
  - name: EnvironmentAzureServiceConnection
    type: string
    displayName: 'Azure service connection for provider authentication'
    default: ''

steps:
  - ${{ if and(eq(parameters.Command, 'init'), eq(parameters.DisableBackend, true)) }}:
      - script: 'terraform init -backend=false'
        displayName: 'Terraform ${{ parameters.Command }}'
        name: TerraformTask_init${{ iif(parameters.TaskNameUniqueSlug, format('_{0}', parameters.TaskNameUniqueSlug), '') }}
        workingDirectory: ${{ parameters.WorkingDirectory }}
        env: ${{ parameters.TaskEnvironmentVariables }}
        condition: ${{ parameters.Condition }}

  - ${{ elseif and(eq(parameters.Command, 'init'), eq(parameters.UseLocalBackend, true)) }}:
      - script: 'terraform init'
        displayName: 'Terraform ${{ parameters.Command }}'
        name: TerraformTask_init${{ iif(parameters.TaskNameUniqueSlug, format('_{0}', parameters.TaskNameUniqueSlug), '') }}
        workingDirectory: ${{ parameters.WorkingDirectory }}
        env: ${{ parameters.TaskEnvironmentVariables }}
        condition: ${{ parameters.Condition }}

  - ${{ else }}:
      - task: TerraformTask@5
        displayName: 'Terraform ${{ parameters.Command }}'
        name: TerraformTask_${{ parameters.Command }}${{ iif(parameters.TaskNameUniqueSlug, format('_{0}', parameters.TaskNameUniqueSlug), '') }}
        env: ${{ parameters.TaskEnvironmentVariables }}
        condition: ${{ parameters.Condition }}
        retryCountOnTaskFailure: ${{ parameters.RetryCountOnTaskFailure }}
        inputs:
          # Core Configuration
          provider: 'azurerm'
          command: '${{ parameters.Command }}'
          ${{ if ne(parameters.WorkingDirectory, '') }}:
            workingDirectory: '${{ parameters.WorkingDirectory }}'

          # Command Options
          ${{ if ne(parameters.CommandOptions, '') }}:
            commandOptions: '${{ parameters.CommandOptions }}'

          ${{ if and(eq(parameters.Command, 'custom'), ne(parameters.CustomCommand, '')) }}:
            customCommand: '${{ parameters.CustomCommand }}'

          # Output Configuration (show/output commands)
          ${{ if or(eq(parameters.Command, 'show'), eq(parameters.Command, 'output')) }}:
            outputTo: '${{ parameters.OutputTo }}'

          ${{ if and(eq(parameters.OutputTo, 'file'), ne(parameters.OutputFileName, '')) }}:
            fileName: '${{ parameters.OutputFileName }}'

          ${{ if and(eq(parameters.Command, 'show'), ne(parameters.OutputFormat, 'default')) }}:
            outputFormat: '${{ parameters.OutputFormat }}'

          # Azure Backend Configuration (init command)
          ${{ if eq(parameters.Command, 'init') }}:
            ${{ if ne(parameters.BackendAzureServiceConnection, '') }}:
              backendServiceArm: '${{ parameters.BackendAzureServiceConnection }}'

            ${{ if ne(parameters.BackendAzureResourceGroupName, '') }}:
              backendAzureRmResourceGroupName: '${{ parameters.BackendAzureResourceGroupName }}'

            ${{ if ne(parameters.BackendAzureStorageAccountName, '') }}:
              backendAzureRmStorageAccountName: '${{ parameters.BackendAzureStorageAccountName }}'

            ${{ if ne(parameters.BackendAzureContainerName, '') }}:
              backendAzureRmContainerName: '${{ parameters.BackendAzureContainerName }}'

            ${{ if ne(parameters.BackendAzureBlobName, '') }}:
              backendAzureRmKey: '${{ parameters.BackendAzureBlobName }}'

          # Azure Provider Configuration (plan/apply/destroy commands)
          ${{ if or(eq(parameters.Command, 'plan'), eq(parameters.Command, 'apply'), eq(parameters.Command, 'destroy'), eq(parameters.Command, 'output')) }}:
            ${{ if ne(parameters.EnvironmentAzureServiceConnection, '') }}:
              environmentServiceNameAzureRM: '${{ parameters.EnvironmentAzureServiceConnection }}'
