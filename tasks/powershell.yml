# tasks/powershell.yml
# Azure DevOps Task: PowerShellTask@2
#
# Purpose:
#   Executes PowerShell scripts in an Azure DevOps pipeline, supporting both inline and file-based scripts.
#   Allows configuration of script arguments, error and preference variables, and advanced options.
#
# Parameters:
#   - TaskEnvironmentVariables (object, optional): Environment variables to be passed to the task.
#   - TargetType (string, required): 'filePath' or 'inline'. Determines script execution mode.
#   - FilePath (string, optional): Path to the PowerShell script (when TargetType is filePath).
#   - InlineScript (string, optional): Inline PowerShell script (when TargetType is inline).
#   - ScriptFileArguments (string, optional): Arguments for the script (when TargetType is filePath).
#   - ErrorActionPreference (string, optional): Error action preference. Default: 'stop'.
#   - WarningPreference (string, optional): Warning preference. Default: 'default'.
#   - InformationPreference (string, optional): Information preference. Default: 'default'.
#   - VerbosePreference (string, optional): Verbose preference. Default: 'default'.
#   - DebugPreference (string, optional): Debug preference. Default: 'default'.
#   - ProgressPreference (string, optional): Progress preference. Default: 'silentlyContinue'.
#   - FailOnStderr (boolean, optional): Fail on standard error. Default: false.
#   - ShowWarnings (boolean, optional): Show warnings as Azure DevOps warnings. Default: false.
#   - IgnoreLASTEXITCODE (boolean, optional): Ignore $LASTEXITCODE. Default: false.
#   - Pwsh (boolean, optional): Use PowerShell Core. Default: false.
#   - WorkingDirectory (string, optional): Working directory for the script.
#   - RunScriptInSeparateScope (boolean, optional): Run script in a separate scope. Default: false.
#
# Example Usage:
#   - template: tasks/powershell.yml
#     parameters:
#       TargetType: 'filePath'
#       FilePath: 'scripts/deploy.ps1'
#       Arguments: '-Verbose'
#       FailOnStderr: true
#
#   - template: tasks/powershell.yml
#     parameters:
#       TargetType: 'inline'
#       Script: |
#         Write-Host "Hello from inline PowerShell"
#       VerbosePreference: 'continue'
#
# Notes:
#   - This template wraps the PowerShell@2 task for reusability and consistency.
#   - Follows YAML best practices and repository standards.

parameters:
  - name: TaskEnvironmentVariables
    type: object
    displayName: 'Environment variables to be passed to the task'
    default: { }

  # PowerShell Task Inputs

  - name: TargetType
    type: string
    displayName: 'Script execution mode (filePath or inline)'
    values:
      - filePath
      - inline

  - name: ScriptFilePath
    type: string
    displayName: 'Path to the PowerShell script (when TargetType is filePath)'
    default: ''

  - name: InlineScript
    type: string
    displayName: 'Inline PowerShell script (when TargetType is inline)'
    default: ''

  - name: ScriptFileArguments
    type: string
    displayName: 'Arguments for the script (when TargetType is filePath)'
    default: ''

  - name: ErrorActionPreference
    type: string
    displayName: 'Error action preference'
    default: 'stop'
    values:
      - default
      - stop
      - continue
      - silentlyContinue

  - name: WarningPreference
    type: string
    displayName: 'Warning preference'
    default: 'default'
    values:
      - default
      - stop
      - continue
      - silentlyContinue

  - name: InformationPreference
    type: string
    displayName: 'Information preference'
    default: 'default'
    values:
      - default
      - stop
      - continue
      - silentlyContinue

  - name: VerbosePreference
    type: string
    displayName: 'Verbose preference'
    default: 'default'
    values:
      - default
      - stop
      - continue
      - silentlyContinue

  - name: DebugPreference
    type: string
    displayName: 'Debug preference'
    default: 'default'
    values:
      - default
      - stop
      - continue
      - silentlyContinue

  - name: ProgressPreference
    type: string
    displayName: 'Progress preference'
    default: 'silentlyContinue'
    values:
      - default
      - stop
      - continue
      - silentlyContinue

  - name: FailOnStderr
    type: boolean
    displayName: 'Fail on standard error'
    default: false

  - name: ShowWarningsInPipelineLogs
    type: boolean
    displayName: 'Show warnings as Azure DevOps warnings'
    default: false

  - name: IgnoreLASTEXITCODE
    type: boolean
    displayName: 'Ignore $LASTEXITCODE (if false, appends `exit $LASTEXITCODE` to propagate external command exit code)'
    default: false

  - name: UsePowerShellCoreOnWindows
    type: boolean
    displayName: 'On Windows, use PowerShell Core (pwsh.exe) instead Windows PowerShell (powershell.exe). No effect on linux.'
    default: false

  - name: WorkingDirectory
    type: string
    displayName: 'Working directory for the script'
    default: ''

  - name: RunScriptInSeparateScope
    type: boolean
    displayName: 'Run script in a separate scope'
    default: false

steps:
  - task: PowerShell@2
    displayName: 'PowerShell ${{ parameters.TargetType }}'
    env: ${{ parameters.TaskEnvironmentVariables }}
    inputs:
      targetType: '${{ parameters.TargetType }}'
      ${{ if and(eq(parameters.TargetType, 'filePath'), ne(parameters.ScriptFilePath, '')) }}:
        filePath: '${{ parameters.ScriptFilePath }}'
      ${{ if and(eq(parameters.TargetType, 'filePath'), ne(parameters.ScriptFileArguments, '')) }}:
        arguments: '${{ parameters.ScriptFileArguments }}'
      ${{ if and(eq(parameters.TargetType, 'inline'), ne(parameters.InlineScript, '')) }}:
        script: '${{ parameters.InlineScript }}'

      # Preference Variables
      errorActionPreference: '${{ parameters.ErrorActionPreference }}'
      warningPreference: '${{ parameters.WarningPreference }}'
      informationPreference: '${{ parameters.InformationPreference }}'
      verbosePreference: '${{ parameters.VerbosePreference }}'
      debugPreference: '${{ parameters.DebugPreference }}'
      progressPreference: '${{ parameters.ProgressPreference }}'

      # Advanced
      failOnStderr: ${{ parameters.FailOnStderr }}
      showWarnings: ${{ parameters.ShowWarningsInPipelineLogs }}
      ignoreLASTEXITCODE: ${{ parameters.IgnoreLASTEXITCODE }}
      pwsh: ${{ parameters.UsePowerShellCoreOnWindows }}
      ${{ if ne(parameters.WorkingDirectory, '') }}:
        workingDirectory: '${{ parameters.WorkingDirectory }}'
      runScriptInSeparateScope: ${{ parameters.RunScriptInSeparateScope }}
