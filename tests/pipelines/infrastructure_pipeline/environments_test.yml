parameters:
  - name: Environments
    type: object
    default:
      - Name: dev
        AzureSubscriptionServiceConnection: Pipeline-CloudDisco
        AzDOEnvironmentName: Discovery
        BackendConfiguration:
          ServiceConnection: Pipeline-CloudDisco
          ResourceGroupName: cheeserg
          StorageAccountName: cheesesa
          ContainerName: cheesecn
          BlobName: cheesebn
        VerificationMode: 'VerifyOnDestroy'
        TerraformEnvironmentVariableMappings:
          TF_VAR_MinRandom: 1000
          TF_VAR_MaxRandom: 100000
        TerraformOutputVariables:
          - random_number
          - random_string
        TerraformVariableFiles:
          - config/common.tfvars
          - config/discovery.tfvars
        DependsOn:
          - build
        Condition: succeeded('build')
      - Name: qa
        AzureSubscriptionServiceConnection: Pipeline-CloudDisco
        AzDOEnvironmentName: Discovery
        BackendConfiguration:
          ServiceConnection: Pipeline-CloudDisco
          ResourceGroupName: cheeserg
          StorageAccountName: cheesesa
          ContainerName: cheesecn
          BlobName: cheesebn
        VerificationMode: 'VerifyOnDestroy'
        TerraformEnvironmentVariableMappings:
          TF_VAR_MinRandom: 1000
          TF_VAR_MaxRandom: 100000
        TerraformOutputVariables:
          - random_number
          - random_string
        TerraformVariableFiles:
          - config/common.tfvars
          - config/discovery.tfvars
        Condition: succeeded('Deploy_dev_Infrastructure')
        DependsOn:
          - Deploy_dev_Infrastructure
      - Name: live
        AzureSubscriptionServiceConnection: Pipeline-CloudDisco
        AzDOEnvironmentName: Discovery
        BackendConfiguration:
          ServiceConnection: Pipeline-CloudDisco
          ResourceGroupName: cheeserg
          StorageAccountName: cheesesa
          ContainerName: cheesecn
          BlobName: cheesebn
        VerificationMode: 'VerifyOnDestroy'
        TerraformEnvironmentVariableMappings:
          TF_VAR_MinRandom: 1000
          TF_VAR_MaxRandom: 100000
        TerraformOutputVariables:
          - random_number
          - random_string
        TerraformVariableFiles:
          - config/common.tfvars
          - config/discovery.tfvars
        Condition: succeeded('Deploy_qa_Infrastructure')
        DependsOn:
          - Deploy_qa_Infrastructure

    displayName: 'Mapping of environments'

resources:
  repositories:
    - repository: AzDOPipelineTemplates
      type: github
      endpoint: UKHO
      name: UKHO/devops-azdo-yaml-pipeline-templates
      ref: ${{ variables['Build.SourceBranch'] }} # Build.SourceBranch doesn't work when you click 'Validate' must click the 'Download full YAML' button as it triggers a build

pool: 'Mare Nectaris'

stages:
  - template: stages/terraform_build.yml@AzDOPipelineTemplates
    parameters:
      RelativePathToTerraformFiles: tests/pipelines/infrastructure_pipeline/test_terraform
      TerraformVersion: latest

  - ${{ each environment in parameters.Environments }}:
      - template: stages/terraform_deploy.yml@AzDOPipelineTemplates
        parameters:
          TerraformVersion: latest
          RunPlanOnly: false

          # Required Parameters Compile Time Protection
          ${{ if or(not(environment.Name), eq(environment.Name, '')) }}:
            "an environment Name is not properly defined and is a required field.": "Error"
          EnvironmentName: ${{ environment.Name }}

          ${{ if or(not(environment.DependsOn), eq(environment.DependsOn, '')) }}:
            "environment '${{environment.Name}}' DependsOn is not properly defined and is a required field.": "Error"
          DependsOn: ${{ environment.DependsOn }}

          ${{ if or(not(environment.Condition), eq(environment.Condition, '')) }}:
            "environment '${{environment.Name}}' Condition is not properly defined and is a required field.": "Error"
          Condition: ${{ environment.Condition }}

          ${{ if or(not(environment.AzDOEnvironmentName), eq(environment.AzDOEnvironmentName, '')) }}:
            "environment '${{environment.Name}}' AzDOEnvironmentName is not properly defined and is a required field.": "Error"
          AzDOEnvironmentName: ${{ environment.AzDOEnvironmentName }}

          ${{ if or(not(environment.AzureSubscriptionServiceConnection), eq(environment.AzureSubscriptionServiceConnection, '')) }}:
            "environment '${{environment.Name}}' AzureSubscriptionServiceConnection is not properly defined and is a required field.": "Error"
          AzureSubscriptionServiceConnection: ${{ environment.AzureSubscriptionServiceConnection }}

          ${{ if or(not(environment.BackendConfiguration.ServiceConnection), eq(environment.BackendConfiguration.ServiceConnection, '')) }}:
            "environment '${{environment.Name}}' BackendConfiguration.ServiceConnection is not properly defined and is a required field.": "Error"
          BackendAzureServiceConnection: ${{ environment.BackendConfiguration.ServiceConnection }}

          ${{ if or(not(environment.BackendConfiguration.ResourceGroupName), eq(environment.BackendConfiguration.ResourceGroupName, '')) }}:
            "environment '${{environment.Name}}' BackendConfiguration.ResourceGroupName is not properly defined and is a required field.": "Error"
          BackendAzureResourceGroupName: ${{ environment.BackendConfiguration.ResourceGroupName }}

          ${{ if or(not(environment.BackendConfiguration.StorageAccountName), eq(environment.BackendConfiguration.StorageAccountName, '')) }}:
            "environment '${{environment.Name}}' BackendConfiguration.StorageAccountName is not properly defined and is a required field.": "Error"
          BackendAzureStorageAccountName: ${{ environment.BackendConfiguration.StorageAccountName }}

          ${{ if or(not(environment.BackendConfiguration.ContainerName), eq(environment.BackendConfiguration.ContainerName, '')) }}:
            "environment '${{environment.Name}}' BackendConfiguration.ContainerName is not properly defined and is a required field.": "Error"
          BackendAzureContainerName: ${{ environment.BackendConfiguration.ContainerName }}

          ${{ if or(not(environment.BackendConfiguration.BlobName), eq(environment.BackendConfiguration.BlobName, '')) }}:
            "environment '${{environment.Name}}' BackendConfiguration.BlobName is not properly defined and is a required field.": "Error"
          BackendAzureBlobName: ${{ environment.BackendConfiguration.BlobName }}

          ${{ if or(not(environment.VerificationMode), eq(environment.VerificationMode, ''), notIn(environment.VerificationMode, 'VerifyOnDestroy', 'VerifyOnAny', 'VerifyDisabled')) }}:
            "environment '${{environment.Name}}' VerificationMode is not properly defined and is a required field.": "Error"
          VerificationMode: ${{ environment.VerificationMode }}

          # Optional Parameters
          ${{ if environment.DeploymentJobsVariableMappings }}: # Add additional validation
            DeploymentJobsVariableMappings: ${{ environment.DeploymentJobsVariableMappings }}

          ${{ if environment.TerraformEnvironmentVariableMappings }}:
            ${{ if not(contains(convertToJson(environment.TerraformEnvironmentVariableMappings), '{')) }}:
              "TerraformEnvironmentVariableMappings is not correct. Must be an object of key/value pairs. You muppet.": "Error"
            ${{ else }}:
              ${{ each mapping in environment.TerraformEnvironmentVariableMappings }}:
                ${{ if or(not(mapping.Key), not(mapping.Value), eq(mapping.Key, ''), eq(mapping.Value, '')) }}:
                  "TerraformEnvironmentVariableMappings is not correct. Must be an object of key/value pairs. You muppet.": "Error"
            ${{ if environment.TerraformEnvironmentVariableMappings }}:
              TerraformEnvironmentVariableMappings: ${{ environment.TerraformEnvironmentVariableMappings }}

          ${{ if environment.TerraformOutputVariables }}: # Add additional validation
            TerraformOutputVariables: ${{ environment.TerraformOutputVariables }}

          ${{ if environment.TerraformVariableFiles }}: # Add additional validation
            TerraformVariableFiles: ${{ environment.TerraformVariableFiles }}
