parameters:
  - name: Environments
    type: object
    default:
      dev:
        AzDOEnvironmentName: Discovery
      qa:
        AzDOEnvironmentName: Discovery
      live:
        AzDOEnvironmentName: Discovery
    displayName: 'Mapping of environments'

resources:
  repositories:
    - repository: AzDOPipelineTemplates
      type: github
      endpoint: UKHO
      name: UKHO/devops-azdo-yaml-pipeline-templates
      ref: ${{ variables['Build.SourceBranch'] }} # Build.SourceBranch doesn't work when you click 'Validate' must click the 'Download full YAML' button as it triggers a build

pool: $(PipelinePool) # Variable defined within the template, overridable via template parameter 'PipelinePool'.

stages:
  - template: stages/terraform_build.yml@AzDOPipelineTemplates
    parameters:
      RelativePathToTerraformFiles: tests/pipelines/infrastructure_pipeline/test_terraform
      TerraformVersion: latest

  - ${{ each environment in parameters.Environments }}:
      - template: stages/terraform_deploy.yml@AzDOPipelineTemplates
        parameters:
          DependsOn:
            - Build
          Condition: succeeded('Build')
          EnvironmentName: ${{ environment.Key }}
          AzureSubscriptionServiceConnection: Pipeline-CloudDisco
          AzDOEnvironmentName: Discovery
          TerraformVersion: latest
          # DeploymentJobsVariableMappings:
          BackendAzureServiceConnection: Pipeline-CloudDisco
          BackendAzureResourceGroupName: m-devopschapter-rg
          BackendAzureStorageAccountName: ukhodoctfstate
          BackendAzureContainerName: tfstate
          BackendAzureBlobName: linux_test.tfstate
          VerificationMode: VerifyOnDestroy
          RunPlanOnly: false
          TerraformEnvironmentVariableMappings:
            TF_VAR_MinRandom: 1000
            TF_VAR_MaxRandom: 100000
          TerraformOutputVariables:
            - random_number
            - random_string
          TerraformVariableFiles:
            - config/common.tfvars
            - config/discovery.tfvars

