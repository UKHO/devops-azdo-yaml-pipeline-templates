parameters:
  - name: Environments
    type: object
    default:
      dev:
        AzureSubscriptionServiceConnection: Pipeline-CloudDisco
        AzDOEnvironmentName: Discovery
        BackendConfiguration:
          ServiceConnection: Pipeline-CloudDisco
          ResourceGroupName: cheeserg
          StorageAccountName: cheesesa
          ContainerName: cheesecn
          BlobName: cheesebn
        VerificationMode: 'VerifyOnAny'
        TerraformEnvironmentVariableMappings:
          TF_VAR_MinRandom: 1000
          TF_VAR_MaxRandom: 100000
        TerraformOutputVariables:
          - random_number
          - random_string
        TerraformVariableFiles:
          - config/common.tfvars
          - config/discovery.tfvars
        Condition: succeeded('build')
        DependsOn:
          - Build
      qa:
        AzureSubscriptionServiceConnection: Pipeline-CloudDisco
        AzDOEnvironmentName: Discovery
        BackendConfiguration:
          ServiceConnection: Pipeline-CloudDisco
          ResourceGroupName: cheeserg
          StorageAccountName: cheesesa
          ContainerName: cheesecn
          BlobName: cheesebn
        VerificationMode: 'VerifyOnAny'
        TerraformEnvironmentVariableMappings:
          TF_VAR_MinRandom: 1000
          TF_VAR_MaxRandom: 100000
        TerraformOutputVariables:
          - random_number
          - random_string
        TerraformVariableFiles:
          - config/common.tfvars
          - config/discovery.tfvars
        Condition: succeeded('Deploy_dev_Infrastructure')
        DependsOn:
          - Deploy_dev_Infrastructure
      live:
        AzureSubscriptionServiceConnection: Pipeline-CloudDisco
        AzDOEnvironmentName: Discovery
        BackendConfiguration:
          ServiceConnection: Pipeline-CloudDisco
          ResourceGroupName: cheeserg
          StorageAccountName: cheesesa
          ContainerName: cheesecn
          BlobName: cheesebn
        VerificationMode: 'VerifyOnAny'
        TerraformEnvironmentVariableMappings:
          TF_VAR_MinRandom: 1000
          TF_VAR_MaxRandom: 100000
        TerraformOutputVariables:
          - random_number
          - random_string
        TerraformVariableFiles:
          - config/common.tfvars
          - config/discovery.tfvars
        Condition: succeeded('Deploy_qa_Infrastructure')
        DependsOn:
          - Deploy_qa_Infrastructure

    displayName: 'Mapping of environments'

resources:
  repositories:
    - repository: AzDOPipelineTemplates
      type: github
      endpoint: UKHO
      name: UKHO/devops-azdo-yaml-pipeline-templates
      ref: ${{ variables['Build.SourceBranch'] }} # Build.SourceBranch doesn't work when you click 'Validate' must click the 'Download full YAML' button as it triggers a build

pool: $(PipelinePool) # Variable defined within the template, overridable via template parameter 'PipelinePool'.

stages:
  - template: stages/terraform_build.yml@AzDOPipelineTemplates
    parameters:
      RelativePathToTerraformFiles: tests/pipelines/infrastructure_pipeline/test_terraform
      TerraformVersion: latest

  - ${{ each environment in parameters.Environments }}:
      - template: stages/terraform_deploy.yml@AzDOPipelineTemplates
        parameters:
          DependsOn: ${{ environment.Value.DependsOn }}
          Condition: ${{ environment.Value.Condition }}
          EnvironmentName: ${{ environment.Key }}
          AzureSubscriptionServiceConnection: ${{ environment.Value.AzureSubscriptionServiceConnection }}
          AzDOEnvironmentName: ${{ environment.Value.AzDOEnvironmentName }}
          TerraformVersion: latest
          # DeploymentJobsVariableMappings:
          BackendAzureServiceConnection: ${{ environment.Value.BackendConfiguration.ServiceConnection }}
          BackendAzureResourceGroupName: ${{ environment.Value.BackendConfiguration.ResourceGroupName }}
          BackendAzureStorageAccountName: ${{ environment.Value.BackendConfiguration.StorageAccountName }}
          BackendAzureContainerName: ${{ environment.Value.BackendConfiguration.ContainerName }}
          BackendAzureBlobName: ${{ environment.Value.BackendConfiguration.BlobName }}
          VerificationMode: ${{ environment.Value.VerificationMode }}
          RunPlanOnly: false
          TerraformEnvironmentVariableMappings: ${{ environment.Value.TerraformEnvironmentVariableMappings }}
          TerraformOutputVariables: ${{ environment.Value.TerraformOutputVariables }}
          TerraformVariableFiles: ${{ environment.Value.TerraformVariableFiles }}
