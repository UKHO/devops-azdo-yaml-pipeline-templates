parameters:
  - name: RunPlanOnly
    type: boolean
    default: false
    displayName: 'Whether to run the plan only'

resources:
  repositories:
    - repository: AzDOPipelineTemplates
      type: github
      endpoint: UKHO
      name: UKHO/devops-azdo-yaml-pipeline-templates
      ref: ${{ variables['Build.SourceBranch'] }} # Build.SourceBranch doesn't work when you click 'Validate' must click the 'Download full YAML' button as it triggers a build

pool: $(PipelinePool) # Variable defined within the template, overridable via template parameter 'PipelinePool'.

extends:
  template: pipelines/infrastructure_pipeline.yml@AzDOPipelineTemplates
  parameters:
    # PipelinePool # do not need to test
    RelativePathToTerraformFiles: tests/pipelines/infrastructure_pipeline/test_terraform
    TerraformVersion: latest
    # TerraformBuildInjectionSteps # do not need to test
    AzDOEnvironmentName: Discovery
    AzureSubscriptionServiceConnection: Pipeline-CloudDisco
    # DeploymentJobsVariableMappings # todo configure this for testing
    BackendAzureServiceConnection: Pipeline-CloudDisco # ?
    BackendAzureResourceGroupName: m-devopschapter-rg
    BackendAzureStorageAccountName: ukhodoctfstatesa
    BackendAzureContainerName: tfstate
    BackendAzureBlobName: linux_test.tfstate
    # KeyVaultServiceConnection: Pipeline-CloudDisco
    # KeyVaultName: aKV
    # KeyVaultSecretsFilter: aSecretFilter
    RunPlanOnly: ${{ parameters.RunPlanOnly }}
    VerificationMode: VerifyOnDestroy
    TerraformEnvironmentVariableMappings:
      TF_VAR_MinRandom: 1000
      TF_VAR_MaxRandom: 100000
    TerraformOutputVariables:
      - random_number
      - random_string
    TerraformVariableFiles:
      - config/common.tfvars
      - config/discovery.tfvars
    Environments:
      dev:
        AzDOEnvironmentName: Discovery
      qa:
        AzDOEnvironmentName: Discovery
      live:
        AzDOEnvironmentName: Discovery
