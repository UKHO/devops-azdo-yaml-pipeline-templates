trigger:
  - experiment/terraform-detect-destruction

jobs:
  - deployment:
    pool: 'Mare Nectaris'
    variables:
      TestVariable: BrickByBrick
      RepositoryCheckoutPath: $(Build.Repository.Name)
      TerraformWorkingDirectory: $(Pipeline.Workspace)/$(RepositoryCheckoutPath)/tests/pipelines/experimental_pipelines/detect_changes/test_terraform
    environment: Discovery
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self
              displayName: 'Checkout self repository'
              path: $(RepositoryCheckoutPath)

            - template: ../../../../tasks/terraform_installer.yml
              parameters:
                TerraformVersion: 1.13.5

            - template: ../../../../tasks/terraform.yml
              parameters:
                Command: init
                BackendAzureServiceConnection: Pipeline-CloudDisco # ?
                BackendAzureResourceGroupName: m-devopschapter-rg
                BackendAzureStorageAccountName: ukhodoctfstatesa
                BackendAzureContainerName: tfstate
                BackendAzureBlobName: linux_test.tfstate
                WorkingDirectory: $(TerraformWorkingDirectory)

            - template: ../../../../tasks/terraform.yml
              parameters:
                Command: plan
                EnvironmentAzureServiceConnection: Pipeline-CloudDisco # ?
                WorkingDirectory: $(TerraformWorkingDirectory)
                TaskEnvironmentVariables:
                  TF_VAR_AzDO_Project_Name: "DevOps Chapter"
                  TF_VAR_Environment_Description: "Test"
