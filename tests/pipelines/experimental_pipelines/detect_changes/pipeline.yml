jobs:
  - deployment:
    variables:
      RepositoryCheckoutPath: $(Build.Repository.Name)
      TerraformWorkingDirectory: $(Pipeline.Workspace)/$(RepositoryCheckoutPath)/tests/pipelines/experimental_pipelines/detect_changes/test_terraform
    environment: Discovery
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self
              displayName: 'Checkout self repository'
              path: $(RepositoryCheckoutPath)

            - template: ../tasks/terraform_installer.yml
              parameters:
                TerraformVersion: 1.13.5

            - template: ../tasks/terraform.yml
              parameters:
                Command: init
                BackendAzureServiceConnection: Pipeline-CloudDisco # ?
                BackendAzureResourceGroupName: m-devopschapter-rg
                BackendAzureStorageAccountName: ukhodoctfstatesa
                BackendAzureContainerName: tfstate
                BackendAzureBlobName: linux_test.tfstate
                WorkingDirectory: $(TerraformWorkingDirectory)

            - template: ../tasks/terraform.yml
              parameters:
                Command: plan
                EnvironmentAzureServiceConnection: Pipeline-CloudDisco # ?
                WorkingDirectory: $(TerraformWorkingDirectory)
                # TaskEnvironmentVariables:
                CommandOptions: '-out=$(System.DefaultWorkingDirectory)/terraform.tfplan -detailed-exitcode'

            - script: "echo '$(TERRAFORM_PLAN_HAS_CHANGES)'"

