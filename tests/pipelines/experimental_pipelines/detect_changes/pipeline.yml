# yaml-language-server: $schema=https://raw.githubusercontent.com/microsoft/azure-pipelines-vscode/master/service-schema.json
# yaml-language-server: $schema=https://json.schemastore.org/yamllint.json

trigger:
  branches:
    include:
      - experiment/*
  paths:
    include:
      - tests/pipelines/experimental_pipelines/*

jobs:
  - job:
    pool: 'Mare Nectaris'
    variables:
      TestVariable: BrickByBrick
      RepositoryCheckoutPath: $(Build.Repository.Name)
      TerraformWorkingDirectory: $(Pipeline.Workspace)/$(RepositoryCheckoutPath)/tests/pipelines/experimental_pipelines/detect_changes/test_terraform
    steps:
      - checkout: self
        displayName: 'Checkout self repository'
        path: $(RepositoryCheckoutPath)

      - template: ../../../../tasks/terraform_installer.yml
        parameters:
          TerraformVersion: 1.13.5

      - template: ../../../../tasks/terraform.yml
        parameters:
          Command: init
          UseLocalBackend: true
          WorkingDirectory: $(TerraformWorkingDirectory)

      - template: ../../../../tasks/terraform.yml
        parameters:
          Command: plan
          EnvironmentAzureServiceConnection: Pipeline-CloudDisco
          WorkingDirectory: $(TerraformWorkingDirectory)
          TaskEnvironmentVariables:
            TF_VAR_Web_App_Description: "Test Description"

      - template: ../../../../tasks/terraform.yml
        parameters:
          Command: apply
          EnvironmentAzureServiceConnection: Pipeline-CloudDisco
          WorkingDirectory: $(TerraformWorkingDirectory)
          TaskEnvironmentVariables:
            TF_VAR_Web_App_Description: "Test Description"

      - template: ../../../../tasks/terraform.yml
        parameters:
          Command: plan
          CommandOptions: '-out=$(TerraformWorkingDirectory)/terraform.tfplan -detailed-exitcode'
          TaskNameUniqueSlug: NewDescription
          EnvironmentAzureServiceConnection: Pipeline-CloudDisco
          WorkingDirectory: $(TerraformWorkingDirectory)
          TaskEnvironmentVariables:
            TF_VAR_Web_App_Description: "Test New Description"

      - script: |
          echo '$(TERRAFORM_PLAN_HAS_CHANGES)'
          sleep 30

      - template: ../../../../tasks/terraform.yml
        parameters:
          Command: apply
          TaskNameUniqueSlug: NewDescription
          EnvironmentAzureServiceConnection: Pipeline-CloudDisco
          WorkingDirectory: $(TerraformWorkingDirectory)
          TaskEnvironmentVariables:
            TF_VAR_Web_App_Description: "Test New Description"

      - template: ../../../../tasks/terraform.yml
        parameters:
          Command: destroy
          EnvironmentAzureServiceConnection: Pipeline-CloudDisco
          WorkingDirectory: $(TerraformWorkingDirectory)
          TaskEnvironmentVariables:
            TF_VAR_Web_App_Description: "Test Description"
