parameters:
  - name: ArtifactName
    type: string
    default: 'TerraformArtifact'
    displayName: 'Artifact Name for Target Path to be saved as.'

  - name: RelativePathToTerraformFiles
    type: string
    default: ''
    displayName: "Target Path to Terraform files (.tf,.tfvars) that require publishing as artifact."

  - name: TerraformVersion
    type: string
    default: 'latest'
    displayName: "Version of Terraform CLI tool to use with the terraform files."

jobs:
  - job: TerraformBuild
    variables:
      RepositoryCheckoutPath: $(Pipeline.Workspace)/self-repository
      TerraformWorkingDirectory: ${{ variables.RepositoryCheckoutPath }}/${{ parameters.RelativePathToTerraformFiles }}
    workspace:
      clean: all
    displayName: "Terraform Build"
    steps:
      - checkout: self
        displayName: "Checkout self repository"
        path: ${{ variables.RepositoryCheckoutPath }}

      - template: ../tasks/terraform_installer.yml
        parameters:
          TerraformVersion: ${{ parameters.TerraformVersion }}

      - template: ../tasks/terraform.yml
        parameters:
          Command: init
          DisableBackend: true
          WorkingDirectory: ${{ variables.TerraformWorkingDirectory }}

      - template: ../tasks/terraform.yml
        parameters:
          Command: validate
          WorkingDirectory: ${{ variables.TerraformWorkingDirectory }}

      - checkout: self
        displayName: "Clean the directory post validation"
        clean: true
        path: ${{ variables.RepositoryCheckoutPath }}

      - template: ../tasks/publish_pipeline_artifact.yml
        parameters:
          TargetPath: ${{ variables.TerraformWorkingDirectory }}
          ArtifactName: ${{ parameters.ArtifactName }}
